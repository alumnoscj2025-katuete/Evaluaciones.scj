<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examen - Castellano 8¬∫ Grado</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; background: #f5f5f5; }
  h1 { color: #333; text-align: center; }
  .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  label { display: block; margin: 6px 0; }
  select, input[type=text] { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
  button { padding: 12px 20px; margin-top: 10px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; }
  #btnEnviar { background-color: #2196F3; color: white; }
  #btnPDF { background-color: #4CAF50; color: white; display: none; }
  .pregunta { margin-bottom: 15px; }
  .opcion { margin-left: 20px; }
  @media(max-width:600px){ select,input[type=text],button{font-size:16px;} }
</style>
</head>
<body>

<h1>üìò Examen de Castellano ‚Äì 8¬∫ Grado</h1>

<!-- BLOQUE DEL TEXTO - NUEVO -->
<div class="card" style="background:#fffbea;">
  <h2 style="margin-top:0;">üìñ Lectura: <i>El Castigo</i> ‚Äî Mario Halley Mora</h2>
  <p>
    El Castigo; de Mario Halley Mora, paraguayo. <br><br>
    Un hombre raro de mi pueblo recuerda que cuando √©l era ni√±o, cazaba pajaritos con un rifle de aire comprimido. 
    √âste observaba la carne muy leve de los canarios y gorriones que se desgarraba al impacto de las municiones. 
    Plumajes azules, verdes, amarillos, rojos, se manchaban con el p√∫rpura de la sangre. <br><br>
    El hombre creci√≥ y se hizo hombre y ya no mataba m√°s pajarillos, sino jabal√≠es, capibaras bonachones, tigres feroces, 
    venados √°giles que a√∫n en la muerte ten√≠an en los ojos el p√°nico y la angustia. Lleg√≥ a viejo y muri√≥ el hombre como cualquier mortal. <br><br>
    En el Infierno inventaron un castigo nuevo para √©l: pasear por un bosque encantado, iluminado con m√∫sica de trinos y sonidos de la selva, 
    adem√°s, lleno de piezas de caza: resorteras, trampas, rifles, jaulas, etc. Y √©l iba sin arma y tembloroso como aquellos animales.
  </p>
</div>

<!-- CONFIGURACI√ìN -->
<div class="card">
  <label for="selTurno">Turno:</label>
  <select id="selTurno"><option value="">-- Turno --</option></select>

  <label for="selGrado">Grado:</label>
  <select id="selGrado"><option value="">-- Grado --</option></select>

  <label for="selEst">Estudiante:</label>
  <select id="selEst"><option value="">-- Estudiante --</option></select>

  <label for="selMat">Materia:</label>
  <select id="selMat"><option value="">-- Materia --</option></select>
</div>

<div id="preguntas"></div>

<button id="btnEnviar">üì§ Enviar Respuestas</button>
<button id="btnPDF">üíæ Generar PDF</button>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzTTvI2QYoBAHcoQKY8YDftGirkD6c5FTUZ0PBkhp83iyJjUFNd0OgKLG4l7iMtu3az/exec";

const selTurno = document.getElementById("selTurno");
const selGrado = document.getElementById("selGrado");
const selEst   = document.getElementById("selEst");
const selMat   = document.getElementById("selMat");
const divPreg  = document.getElementById("preguntas");
const btnEnviar= document.getElementById("btnEnviar");
const btnPDF   = document.getElementById("btnPDF");


// ==============================
//   EXAMEN COMPLETO
// ==============================
const examenData = [
{
  pregunta: "1. Las palabras que tienen su sin√≥nimo correcto:",
  tipo: "multiple",
  opciones: [
    "a. rifle (arma)",
    "b. rifle (afligido)",
    "c. rifle (municiones)"
  ],
  correcta: "a. rifle (arma)"
},
{
  pregunta: "2. El personaje principal es:",
  tipo: "multiple",
  opciones: [
    "a. Mario Halley Mora",
    "b. El hombre raro",
    "c. Desconocido"
  ],
  correcta: "b. El hombre raro"
},
{
  pregunta: "3. El emisor del texto es:",
  tipo: "multiple",
  opciones: [
    "a. Mario Halley Mora",
    "b. El que lee",
    "c. El hombre raro"
  ],
  correcta: "a. Mario Halley Mora"
},
{
  pregunta: "4. El g√©nero literario del texto le√≠do:",
  tipo: "multiple",
  opciones: [
    "a. Narrativo",
    "b. Period√≠stico",
    "c. Po√©tico"
  ],
  correcta: "a. Narrativo"
},
{
  pregunta: "5. El castigo al hombre raro es justo porque:",
  tipo: "multiple",
  opciones: [
    "a. Actu√≥ mal",
    "b. Se divierte",
    "c. Actu√≥ bien"
  ],
  correcta: "a. Actu√≥ mal"
},
{
  pregunta: "6. ¬øC√≥mo es la relaci√≥n con la Naturaleza del hombre raro?",
  tipo: "multiple",
  opciones: [
    "a. Consciente",
    "b. Inconsciente",
    "c. Buena"
  ],
  correcta: "b. Inconsciente"
},
{
  pregunta: "7. Seg√∫n el texto, podemos deducir que:",
  tipo: "multiple",
  opciones: [
    "a. Cada quien recibe al final de su vida su merecido",
    "b. La vida es injusta",
    "c. Nadie recibe lo que merece"
  ],
  correcta: "a. Cada quien recibe al final de su vida su merecido"
},
{
  pregunta: "8. El mensaje del escritor sobre la naturaleza es:",
  tipo: "multiple",
  opciones: [
    "a. No es bueno matar por matar a los animales",
    "b. Nunca se debe matar a los animales",
    "c. Es divertida la matanza de los animales"
  ],
  correcta: "a. No es bueno matar por matar a los animales"
},
{
  pregunta: "9. El texto est√° organizado en:",
  tipo: "multiple",
  opciones: [
    "a. Estrofas",
    "b. P√°rrafos",
    "c. Ninguno es correcto"
  ],
  correcta: "b. P√°rrafos"
},
{
  pregunta: "10. ‚ÄúY √©l iba sin arma y tembloroso como aquellos animales‚Äù es una expresi√≥n llamada:",
  tipo: "multiple",
  opciones: [
    "a. Met√°fora",
    "b. Personificaci√≥n",
    "c. Comparaci√≥n"
  ],
  correcta: "c. Comparaci√≥n"
}
];


// ==============================
//   FUNCIONAMIENTO DEL SISTEMA
// ==============================

window.onload = () => {
  cargarConfig();
  selTurno.onchange = cargarEstudiantes;
  selGrado.onchange = cargarEstudiantes;
  selMat.onchange   = mostrarPreguntas;
  btnEnviar.onclick = enviar;
  btnPDF.onclick    = generarPDF;
};

async function cargarConfig(){
  try {
    const res = await fetch(`${URL_SCRIPT}?action=config`);
    const cfg = await res.json();
    llenarSelect(selGrado,cfg.grados);
    llenarSelect(selTurno,cfg.turnos);
    llenarSelect(selMat,cfg.materias);
  } catch(err){
    alert("‚ùå Error al cargar configuraci√≥n: "+err.message);
  }
}

function llenarSelect(select,arr){
  select.innerHTML = "";
  const def = select===selGrado?"-- Grado --": select===selTurno?"-- Turno --":"-- Materia --";
  select.appendChild(new Option(def,""));
  arr.forEach(v=>select.appendChild(new Option(v,v)));
}

async function cargarEstudiantes(){
  const g=selGrado.value, t=selTurno.value;
  if(!g||!t) return;
  try{
    const res = await fetch(`${URL_SCRIPT}?action=estudiantes&grado=${g}&turno=${t}`);
    const lst = await res.json();
    selEst.innerHTML="";
    selEst.appendChild(new Option("-- Estudiante --",""));
    lst.forEach(e=>selEst.appendChild(new Option(e.nombre,e.nombre)));
  }catch(err){
    alert("‚ùå Error al cargar estudiantes: "+err.message);
  }
}

function mostrarPreguntas(){
  divPreg.innerHTML="";
  examenData.forEach((q,i)=>{
    let html=`<div class="card pregunta"><p><b>${q.pregunta}</b></p>`;
    if(q.tipo==="multiple"){
      q.opciones.forEach(opt=>{
        html+=`<label class="opcion"><input type="radio" name="p${i}" value="${opt}"> ${opt}</label>`;
      });
    }
    html+="</div>";
    divPreg.insertAdjacentHTML("beforeend",html);
  });
}

async function enviar(){
  const est=selEst.value, mat=selMat.value, g=selGrado.value, t=selTurno.value;
  if(!est||!mat) return alert("‚ö†Ô∏è Complet√° todos los campos");

  const preguntas=examenData.map(q=>q.pregunta);
  const correctas=examenData.map(q=>q.correcta);
  const respuestas=examenData.map((_,i)=>{
    const sel=document.querySelector(`input[name='p${i}']:checked`);
    return sel? sel.value : "";
  });

  let nota=0;
  respuestas.forEach((r,i)=>{ 
    if((r||"").trim().toLowerCase() === (correctas[i]||"").trim().toLowerCase()) nota++; 
  });

  const payload={estudiante:est,grado:g,turno:t,materia:mat,preguntas,respuestas,correctas,nota};

  try{
    const res = await fetch(URL_SCRIPT,{
      method:"POST",
      headers:{"Content-Type":"text/plain"},
      body:JSON.stringify(payload)
    });
    const ok = await res.json();
    if(ok.status==="ok"){
      alert(`‚úÖ Nota: ${nota}/${correctas.length}`);
      btnPDF.style.display="inline-block";
    } else {
      alert("‚ùå Error al guardar respuestas en Sheets");
    }
  }catch(err){
    alert("‚ùå Error guardando respuestas.");
    console.error(err);
  }
}

function generarPDF(){
  const contenido=divPreg.innerHTML;
  const win=window.open('','','width=800,height=600');
  win.document.write('<html><head><title>Examen PDF</title></head><body>');
  win.document.write(`<h1>Examen - ${selMat.value}</h1>`);
  win.document.write(`<h3>Estudiante: ${selEst.value}</h3>`);
  win.document.write(contenido);
  win.document.write('</body></html>');
  win.document.close();
  win.print();
}
</script>
</body>
</html>
